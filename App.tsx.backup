import React, { useState, useEffect, createContext, useContext } from 'react';
import { StatusBar } from 'expo-status-bar';
import {
  StyleSheet,
  Text,
  View,
  TextInput,
  TouchableOpacity,
  ScrollView,
  SafeAreaView,
  Dimensions,
  Alert,
  FlatList,
  Modal,
  KeyboardAvoidingView,
  Platform,
  Image
} from 'react-native';
import { LinearGradient } from 'expo-linear-gradient';
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
  User
} from 'firebase/auth';
import { doc, setDoc } from 'firebase/firestore';
import { auth, db } from './src/config/firebase';
import MapScreen from './src/components/MapScreen';
import SingaporeMapScreen from './components/SingaporeMapScreen';
import InfoScreen from './src/components/InfoScreen';
import QuizScreen from './src/components/QuizScreen';
import ReportScreen from './src/components/ReportScreen';
import HomeScreen from './src/components/HomeScreen';
import ChatbotButton from './components/ChatbotButton';
import { styles, authStyles } from './src/styles/styles';
import { LineChart } from 'react-native-chart-kit';
import FontAwesome5 from 'react-native-vector-icons/FontAwesome5';

const { width, height } = Dimensions.get('window');

// Create language context
export const LanguageContext = createContext({
  language: 'english',
  setLanguage: (lang: string) => { },
  translations: {} as Record<string, Record<string, string>>
});

// Define translations
const translations = {
  english: {
    welcome: "Welcome",
    healthPulse: "Singapore Health Pulse",
    tagline: "Real-time health monitoring and reporting",
    populationStats: "Population Stats",
    totalPopulation: "Total Population",
    todayStatistics: "Today's Statistics",
    birthsToday: "Births Today",
    deathsToday: "Deaths Today",
    netMigration: "Net Migration",
    populationGrowth: "Population Growth",
    healthOverview: "Health Overview",
    activeDengueCases: "Active Dengue Cases",
    airQuality: "Air Quality",
    lifeExpectancy: "Life Expectancy",
    dengueAvgPsi: "7-Day Dengue & Avg PSI",
    dengueCases: "7-Day Dengue Cases",
    avgPsi: "Avg PSI (4 regions)",
    dengueTrend: "Dengue Cases Trend (7 Days)",
    totalDengueCases: "Total Dengue Cases",
    demographics: "Demographics",
    male: "Male",
    female: "Female",
    logout: "Logout",
    language: "Language",
    english: "English",
    chinese: "Chinese",
    malay: "Malay",
    tamil: "Tamil",
    hindi: "Hindi",

    // Navigation bar
    home: "Home",
    map: "Map",
    quiz: "Quiz",
    reports: "Reports",
    profile: "Profile",

    // Profile information
    profileInformation: "Profile Information",
    fullName: "Full Name",
    username: "Username",
    phoneNumber: "Phone Number",
    country: "Country",
    homeAddress: "Home Address",
    email: "Email",
    memberSince: "Member Since",
    emailCannotBeChanged: "Email cannot be changed",
    notProvided: "Not provided",
    edit: "Edit",
    cancel: "Cancel",
    saveChanges: "Save Changes",
    confirmLogout: "Confirm Logout",
    areYouSureLogout: "Are you sure you want to logout?",
    loading: "Loading...",
    loadingProfile: "Loading profile...",
    login: "Login",
    signUp: "Sign Up",
    password: "Password",
    selectCountry: "Select your country",
    pleaseWait: "Please wait...",
    createAccount: "Create Account",

    // Error messages
    error: "Error",
    fillAllFields: "Please fill in all fields",
    loginError: "Login Error",
    signupError: "Signup Error",
    success: "Success",
    accountCreated: "Account created successfully!",
    accountCreatedWithError: "Your account was created successfully, but there was an issue saving your profile data. Error: {0}\n\nYou can update your profile later in the app."
  },
  chinese: {
    welcome: "Ê¨¢Ëøé",
    healthPulse: "Êñ∞Âä†Âù°ÂÅ•Â∫∑ËÑâÊêè",
    tagline: "ÂÆûÊó∂ÂÅ•Â∫∑ÁõëÊµãÂíåÊä•Âëä",
    populationStats: "‰∫∫Âè£ÁªüËÆ°",
    totalPopulation: "ÊÄª‰∫∫Âè£",
    todayStatistics: "‰ªäÊó•ÁªüËÆ°",
    birthsToday: "‰ªäÊó•Âá∫Áîü",
    deathsToday: "‰ªäÊó•Ê≠ª‰∫°",
    netMigration: "ÂáÄËøÅÁßª",
    populationGrowth: "‰∫∫Âè£Â¢ûÈïø",
    healthOverview: "ÂÅ•Â∫∑Ê¶ÇËßà",
    activeDengueCases: "Ê¥ªË∑ÉÁôªÈù©ÁÉ≠ÁóÖ‰æã",
    airQuality: "Á©∫Ê∞îË¥®Èáè",
    lifeExpectancy: "È¢ÑÊúüÂØøÂëΩ",
    dengueAvgPsi: "7Â§©ÁôªÈù©ÁÉ≠ÂíåÂπ≥ÂùáPSI",
    dengueCases: "7Â§©ÁôªÈù©ÁÉ≠ÁóÖ‰æã",
    avgPsi: "Âπ≥ÂùáPSIÔºà4‰∏™Âú∞Âå∫Ôºâ",
    dengueTrend: "ÁôªÈù©ÁÉ≠ÁóÖ‰æãË∂ãÂäøÔºà7Â§©Ôºâ",
    totalDengueCases: "ÁôªÈù©ÁÉ≠ÁóÖ‰æãÊÄªÊï∞",
    demographics: "‰∫∫Âè£ÁªüËÆ°Â≠¶",
    male: "Áî∑ÊÄß",
    female: "Â•≥ÊÄß",
    logout: "ÁôªÂá∫",
    language: "ËØ≠Ë®Ä",
    english: "Ëã±ËØ≠",
    chinese: "‰∏≠Êñá",
    malay: "È©¨Êù•ËØ≠",
    tamil: "Ê≥∞Á±≥Â∞îËØ≠",
    hindi: "Âç∞Âú∞ËØ≠",

    // Navigation bar
    home: "È¶ñÈ°µ",
    map: "Âú∞Âõæ",
    quiz: "ÊµãÈ™å",
    reports: "Êä•Âëä",
    profile: "‰∏™‰∫∫ËµÑÊñô",

    // Profile information
    profileInformation: "‰∏™‰∫∫ËµÑÊñô‰ø°ÊÅØ",
    fullName: "ÂÖ®Âêç",
    username: "Áî®Êà∑Âêç",
    phoneNumber: "ÁîµËØùÂè∑Á†Å",
    country: "ÂõΩÂÆ∂",
    homeAddress: "ÂÆ∂Â∫≠‰ΩèÂùÄ",
    email: "ÁîµÂ≠êÈÇÆ‰ª∂",
    memberSince: "‰ºöÂëòÊ≥®ÂÜåÊó∂Èó¥",
    emailCannotBeChanged: "ÁîµÂ≠êÈÇÆ‰ª∂Êó†Ê≥ïÊõ¥Êîπ",
    notProvided: "Êú™Êèê‰æõ",
    edit: "ÁºñËæë",
    cancel: "ÂèñÊ∂à",
    saveChanges: "‰øùÂ≠òÊõ¥Êîπ",
    confirmLogout: "Á°ÆËÆ§ÁôªÂá∫",
    areYouSureLogout: "ÊÇ®Á°ÆÂÆöË¶ÅÁôªÂá∫ÂêóÔºü",
    loading: "Âä†ËΩΩ‰∏≠...",
    loadingProfile: "Âä†ËΩΩ‰∏™‰∫∫ËµÑÊñô‰∏≠...",
    login: "ÁôªÂΩï",
    signUp: "Ê≥®ÂÜå",
    password: "ÂØÜÁ†Å",
    selectCountry: "ÈÄâÊã©ÂõΩÂÆ∂",
    pleaseWait: "ËØ∑Á®çÂÄô...",
    createAccount: "ÂàõÂª∫Ë¥¶Êà∑",

    // Error messages
    error: "ÈîôËØØ",
    fillAllFields: "ËØ∑Â°´ÂÜôÊâÄÊúâÂ≠óÊÆµ",
    loginError: "ÁôªÂΩïÈîôËØØ",
    signupError: "Ê≥®ÂÜåÈîôËØØ",
    success: "ÊàêÂäü",
    accountCreated: "Ë¥¶Êà∑ÂàõÂª∫ÊàêÂäüÔºÅ",
    accountCreatedWithError: "ÊÇ®ÁöÑË¥¶Êà∑Â∑≤ÊàêÂäüÂàõÂª∫Ôºå‰ΩÜ‰øùÂ≠ò‰∏™‰∫∫ËµÑÊñôÊï∞ÊçÆÊó∂Âá∫Áé∞ÈóÆÈ¢ò„ÄÇÈîôËØØÔºö{0}\n\nÊÇ®ÂèØ‰ª•Á®çÂêéÂú®Â∫îÁî®‰∏≠Êõ¥Êñ∞ÊÇ®ÁöÑ‰∏™‰∫∫ËµÑÊñô„ÄÇ"
  },
  malay: {
    welcome: "Selamat Datang",
    healthPulse: "Denyut Kesihatan Singapura",
    tagline: "Pemantauan dan pelaporan kesihatan masa nyata",
    populationStats: "Statistik Penduduk",
    totalPopulation: "Jumlah Penduduk",
    todayStatistics: "Statistik Hari Ini",
    birthsToday: "Kelahiran Hari Ini",
    deathsToday: "Kematian Hari Ini",
    netMigration: "Migrasi Bersih",
    populationGrowth: "Pertumbuhan Penduduk",
    healthOverview: "Gambaran Kesihatan",
    activeDengueCases: "Kes Denggi Aktif",
    airQuality: "Kualiti Udara",
    lifeExpectancy: "Jangka Hayat",
    dengueAvgPsi: "7-Hari Denggi & Purata PSI",
    dengueCases: "Kes Denggi 7-Hari",
    avgPsi: "Purata PSI (4 wilayah)",
    dengueTrend: "Trend Kes Denggi (7 Hari)",
    totalDengueCases: "Jumlah Kes Denggi",
    demographics: "Demografi",
    male: "Lelaki",
    female: "Perempuan",
    logout: "Log Keluar",
    language: "Bahasa",
    english: "Bahasa Inggeris",
    chinese: "Cina",
    malay: "Melayu",
    tamil: "Tamil",
    hindi: "Hindi",

    // Navigation bar
    home: "Rumah",
    map: "Peta",
    quiz: "Kuiz",
    reports: "Laporan",
    profile: "Profil",

    // Profile information
    profileInformation: "Maklumat Profil",
    fullName: "Nama Penuh",
    username: "Nama Pengguna",
    phoneNumber: "Nombor Telefon",
    country: "Negara",
    homeAddress: "Alamat Rumah",
    email: "E-mel",
    memberSince: "Ahli Sejak",
    emailCannotBeChanged: "E-mel tidak boleh diubah",
    notProvided: "Tidak disediakan",
    edit: "Edit",
    cancel: "Batal",
    saveChanges: "Simpan Perubahan",
    confirmLogout: "Sahkan Log Keluar",
    areYouSureLogout: "Adakah anda pasti untuk log keluar?",
    loading: "Memuatkan...",
    loadingProfile: "Memuatkan profil...",
    login: "Log Masuk",
    signUp: "Daftar",
    password: "Kata Laluan",
    selectCountry: "Pilih negara anda",
    pleaseWait: "Sila tunggu...",
    createAccount: "Cipta Akaun",

    // Error messages
    error: "Ralat",
    fillAllFields: "Sila isi semua ruangan",
    loginError: "Ralat Log Masuk",
    signupError: "Ralat Pendaftaran",
    success: "Berjaya",
    accountCreated: "Akaun berjaya dicipta!",
    accountCreatedWithError: "Akaun anda telah berjaya dicipta, tetapi terdapat masalah menyimpan data profil anda. Ralat: {0}\n\nAnda boleh mengemas kini profil anda kemudian dalam aplikasi."
  },
  tamil: {
    welcome: "‡Æµ‡Æ∞‡Æµ‡Øá‡Æ±‡Øç‡Æï‡Æø‡Æ±‡Øã‡ÆÆ‡Øç",
    healthPulse: "‡Æö‡Æø‡Æô‡Øç‡Æï‡Æ™‡Øç‡Æ™‡ØÇ‡Æ∞‡Øç ‡Æö‡ØÅ‡Æï‡Ææ‡Æ§‡Ææ‡Æ∞ ‡Æ§‡ØÅ‡Æü‡Æø‡Æ™‡Øç‡Æ™‡ØÅ",
    tagline: "‡Æ®‡Æø‡Æï‡Æ¥‡Øç‡Æ®‡Øá‡Æ∞ ‡Æö‡ØÅ‡Æï‡Ææ‡Æ§‡Ææ‡Æ∞ ‡Æï‡Æ£‡Øç‡Æï‡Ææ‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà",
    populationStats: "‡ÆÆ‡Æï‡Øç‡Æï‡Æ≥‡Øç‡Æ§‡Øä‡Æï‡Øà ‡Æ™‡ØÅ‡Æ≥‡Øç‡Æ≥‡Æø‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç",
    totalPopulation: "‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡ÆÆ‡Æï‡Øç‡Æï‡Æ≥‡Øç‡Æ§‡Øä‡Æï‡Øà",
    todayStatistics: "‡Æá‡Æ©‡Øç‡Æ±‡Øà‡ÆØ ‡Æ™‡ØÅ‡Æ≥‡Øç‡Æ≥‡Æø‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç",
    birthsToday: "‡Æá‡Æ©‡Øç‡Æ±‡ØÅ ‡Æ™‡Æø‡Æ±‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç",
    deathsToday: "‡Æá‡Æ©‡Øç‡Æ±‡ØÅ ‡Æá‡Æ±‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç",
    netMigration: "‡Æ®‡Æø‡Æï‡Æ∞ ‡Æï‡ØÅ‡Æü‡Æø‡ÆØ‡Øá‡Æ±‡Øç‡Æ±‡ÆÆ‡Øç",
    populationGrowth: "‡ÆÆ‡Æï‡Øç‡Æï‡Æ≥‡Øç‡Æ§‡Øä‡Æï‡Øà ‡Æµ‡Æ≥‡Æ∞‡Øç‡Æö‡Øç‡Æö‡Æø",
    healthOverview: "‡Æö‡ØÅ‡Æï‡Ææ‡Æ§‡Ææ‡Æ∞ ‡Æï‡Æ£‡Øç‡Æ£‡Øã‡Æü‡Øç‡Æü‡ÆÆ‡Øç",
    activeDengueCases: "‡Æö‡ØÜ‡ÆØ‡Æ≤‡Æø‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥ ‡Æü‡ØÜ‡Æô‡Øç‡Æï‡ØÅ ‡Æµ‡Æ¥‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æ≥‡Øç",
    airQuality: "‡Æï‡Ææ‡Æ±‡Øç‡Æ±‡Æø‡Æ©‡Øç ‡Æ§‡Æ∞‡ÆÆ‡Øç",
    lifeExpectancy: "‡Æµ‡Ææ‡Æ¥‡Øç‡Æï‡Øç‡Æï‡Øà ‡Æé‡Æ§‡Æø‡Æ∞‡Øç‡Æ™‡Ææ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡ØÅ",
    dengueAvgPsi: "7-‡Æ®‡Ææ‡Æ≥‡Øç ‡Æü‡ØÜ‡Æô‡Øç‡Æï‡ØÅ & ‡Æö‡Æ∞‡Ææ‡Æö‡Æ∞‡Æø PSI",
    dengueCases: "7-‡Æ®‡Ææ‡Æ≥‡Øç ‡Æü‡ØÜ‡Æô‡Øç‡Æï‡ØÅ ‡Æµ‡Æ¥‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æ≥‡Øç",
    avgPsi: "‡Æö‡Æ∞‡Ææ‡Æö‡Æ∞‡Æø PSI (4 ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡Æï‡Æ≥‡Øç)",
    dengueTrend: "‡Æü‡ØÜ‡Æô‡Øç‡Æï‡ØÅ ‡Æµ‡Æ¥‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æ≥‡Øç ‡Æ™‡Øã‡Æï‡Øç‡Æï‡ØÅ (7 ‡Æ®‡Ææ‡Æü‡Øç‡Æï‡Æ≥‡Øç)",
    totalDengueCases: "‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æü‡ØÜ‡Æô‡Øç‡Æï‡ØÅ ‡Æµ‡Æ¥‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æ≥‡Øç",
    demographics: "‡ÆÆ‡Æï‡Øç‡Æï‡Æ≥‡Øç‡Æ§‡Øä‡Æï‡Øà",
    male: "‡ÆÜ‡Æ£‡Øç",
    female: "‡Æ™‡ØÜ‡Æ£‡Øç",
    logout: "‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡ØÅ",
    language: "‡ÆÆ‡Øä‡Æ¥‡Æø",
    english: "‡ÆÜ‡Æô‡Øç‡Æï‡Æø‡Æ≤‡ÆÆ‡Øç",
    chinese: "‡Æö‡ØÄ‡Æ©‡ÆÆ‡Øç",
    malay: "‡ÆÆ‡Æ≤‡Ææ‡ÆØ‡Øç",
    tamil: "‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç",
    hindi: "‡Æá‡Æ®‡Øç‡Æ§‡Æø",

    // Navigation bar
    home: "‡ÆÆ‡ØÅ‡Æï‡Æ™‡Øç‡Æ™‡ØÅ",
    map: "‡Æµ‡Æ∞‡Øà‡Æ™‡Æü‡ÆÆ‡Øç",
    quiz: "‡Æµ‡Æø‡Æ©‡Ææ‡Æü‡Æø‡Æµ‡Æø‡Æ©‡Ææ",
    reports: "‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øç",
    profile: "‡Æö‡ØÅ‡ÆØ‡Æµ‡Æø‡Æµ‡Æ∞‡ÆÆ‡Øç",

    // Profile information
    profileInformation: "‡Æö‡ØÅ‡ÆØ‡Æµ‡Æø‡Æµ‡Æ∞ ‡Æ§‡Æï‡Æµ‡Æ≤‡Øç",
    fullName: "‡ÆÆ‡ØÅ‡Æ¥‡ØÅ ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç",
    username: "‡Æ™‡ÆØ‡Æ©‡Æ∞‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç",
    phoneNumber: "‡Æ§‡Øä‡Æ≤‡Øà‡Æ™‡Øá‡Æö‡Æø ‡Æé‡Æ£‡Øç",
    country: "‡Æ®‡Ææ‡Æü‡ØÅ",
    homeAddress: "‡Æµ‡ØÄ‡Æü‡Øç‡Æü‡ØÅ ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø",
    email: "‡ÆÆ‡Æø‡Æ©‡Øç‡Æ©‡Æû‡Øç‡Æö‡Æ≤‡Øç",
    memberSince: "‡Æâ‡Æ±‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æ©‡Æ∞‡Øç ‡ÆÜ‡Æ©‡Æ§‡ØÅ",
    emailCannotBeChanged: "‡ÆÆ‡Æø‡Æ©‡Øç‡Æ©‡Æû‡Øç‡Æö‡Æ≤‡Øà ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ± ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Ææ‡Æ§‡ØÅ",
    notProvided: "‡Æµ‡Æ¥‡Æô‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà",
    edit: "‡Æ§‡Æø‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ",
    cancel: "‡Æ∞‡Æ§‡Øç‡Æ§‡ØÅ",
    saveChanges: "‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æô‡Øç‡Æï‡Æ≥‡Øà ‡Æö‡Øá‡ÆÆ‡Æø",
    confirmLogout: "‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡ØÅ‡Æµ‡Æ§‡Øà ‡Æâ‡Æ±‡ØÅ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç",
    areYouSureLogout: "‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ®‡Æø‡Æö‡Øç‡Æö‡ÆØ‡ÆÆ‡Ææ‡Æï ‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ± ‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ?",
    loading: "‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...",
    loadingProfile: "‡Æö‡ØÅ‡ÆØ‡Æµ‡Æø‡Æµ‡Æ∞‡ÆÆ‡Øç ‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...",
    login: "‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà",
    signUp: "‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç",
    password: "‡Æï‡Æü‡Æµ‡ØÅ‡Æö‡Øç‡Æö‡Øä‡Æ≤‡Øç",
    selectCountry: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ®‡Ææ‡Æü‡Øç‡Æü‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",
    pleaseWait: "‡Æ§‡ÆØ‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ ‡Æï‡Ææ‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç...",
    createAccount: "‡Æï‡Æ£‡Æï‡Øç‡Æï‡Øà ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",

    // Error messages
    error: "‡Æ™‡Æø‡Æ¥‡Øà",
    fillAllFields: "‡Æ§‡ÆØ‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ ‡ÆÖ‡Æ©‡Øà‡Æ§‡Øç‡Æ§‡ØÅ ‡Æ™‡ØÅ‡Æ≤‡Æô‡Øç‡Æï‡Æ≥‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æ®‡Æø‡Æ∞‡Æ™‡Øç‡Æ™‡Æµ‡ØÅ‡ÆÆ‡Øç",
    loginError: "‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà‡Æµ‡ØÅ ‡Æ™‡Æø‡Æ¥‡Øà",
    signupError: "‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æ™‡Æø‡Æ¥‡Øà",
    success: "‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø",
    accountCreated: "‡Æï‡Æ£‡Æï‡Øç‡Æï‡ØÅ ‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø‡Æï‡Æ∞‡ÆÆ‡Ææ‡Æï ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ!",
    accountCreatedWithError: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Æ£‡Æï‡Øç‡Æï‡ØÅ ‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø‡Æï‡Æ∞‡ÆÆ‡Ææ‡Æï ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ, ‡ÆÜ‡Æ©‡Ææ‡Æ≤‡Øç ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æö‡ØÅ‡ÆØ‡Æµ‡Æø‡Æµ‡Æ∞ ‡Æ§‡Æ∞‡Æµ‡Øà‡Æö‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æ™‡Øç‡Æ™‡Æ§‡Æø‡Æ≤‡Øç ‡Æö‡Æø‡Æï‡Øç‡Æï‡Æ≤‡Øç ‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Æ§‡ØÅ. ‡Æ™‡Æø‡Æ¥‡Øà: {0}\n\n‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Æø‡Æ©‡Øç‡Æ©‡Æ∞‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Ææ‡Æü‡Øç‡Æü‡Æø‡Æ≤‡Øç ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æö‡ØÅ‡ÆØ‡Æµ‡Æø‡Æµ‡Æ∞‡Æ§‡Øç‡Æ§‡Øà ‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç."
  },
  hindi: {
    welcome: "‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à",
    healthPulse: "‡§∏‡§ø‡§Ç‡§ó‡§æ‡§™‡•Å‡§∞ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§™‡§≤‡•ç‡§∏",
    tagline: "‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§∏‡§Æ‡§Ø ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§®‡§ø‡§ó‡§∞‡§æ‡§®‡•Ä ‡§î‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡§ø‡§Ç‡§ó",
    populationStats: "‡§ú‡§®‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§Ü‡§Ç‡§ï‡§°‡§º‡•á",
    totalPopulation: "‡§ï‡•Å‡§≤ ‡§ú‡§®‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ",
    todayStatistics: "‡§Ü‡§ú ‡§ï‡•á ‡§Ü‡§Ç‡§ï‡§°‡§º‡•á",
    birthsToday: "‡§Ü‡§ú ‡§ú‡§®‡•ç‡§Æ",
    deathsToday: "‡§Ü‡§ú ‡§Æ‡•É‡§§‡•ç‡§Ø‡•Å",
    netMigration: "‡§∂‡•Å‡§¶‡•ç‡§ß ‡§™‡•ç‡§∞‡§µ‡§æ‡§∏‡§®",
    populationGrowth: "‡§ú‡§®‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§µ‡•É‡§¶‡•ç‡§ß‡§ø",
    healthOverview: "‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§Ö‡§µ‡§≤‡•ã‡§ï‡§®",
    activeDengueCases: "‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§°‡•á‡§Ç‡§ó‡•Ç ‡§ï‡•á ‡§Æ‡§æ‡§Æ‡§≤‡•á",
    airQuality: "‡§µ‡§æ‡§Ø‡•Å ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ",
    lifeExpectancy: "‡§ú‡•Ä‡§µ‡§® ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§æ‡§∂‡§æ",
    dengueAvgPsi: "7-‡§¶‡§ø‡§® ‡§°‡•á‡§Ç‡§ó‡•Ç ‡§î‡§∞ ‡§î‡§∏‡§§ PSI",
    dengueCases: "7-‡§¶‡§ø‡§® ‡§°‡•á‡§Ç‡§ó‡•Ç ‡§ï‡•á ‡§Æ‡§æ‡§Æ‡§≤‡•á",
    avgPsi: "‡§î‡§∏‡§§ PSI (4 ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞)",
    dengueTrend: "‡§°‡•á‡§Ç‡§ó‡•Ç ‡§ï‡•á ‡§Æ‡§æ‡§Æ‡§≤‡•ã‡§Ç ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§µ‡•É‡§§‡•ç‡§§‡§ø (7 ‡§¶‡§ø‡§®)",
    totalDengueCases: "‡§ï‡•Å‡§≤ ‡§°‡•á‡§Ç‡§ó‡•Ç ‡§ï‡•á ‡§Æ‡§æ‡§Æ‡§≤‡•á",
    demographics: "‡§ú‡§®‡§∏‡§æ‡§Ç‡§ñ‡•ç‡§Ø‡§ø‡§ï‡•Ä",
    male: "‡§™‡•Å‡§∞‡•Å‡§∑",
    female: "‡§Æ‡§π‡§ø‡§≤‡§æ",
    logout: "‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü",
    language: "‡§≠‡§æ‡§∑‡§æ",
    english: "‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§º‡•Ä",
    chinese: "‡§ö‡•Ä‡§®‡•Ä",
    malay: "‡§Æ‡§≤‡§Ø",
    tamil: "‡§§‡§Æ‡§ø‡§≤",
    hindi: "‡§π‡§ø‡§Ç‡§¶‡•Ä",

    // Navigation bar
    home: "‡§π‡•ã‡§Æ",
    map: "‡§Æ‡•à‡§™",
    quiz: "‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä",
    reports: "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü",
    profile: "‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤",

    // Profile information
    profileInformation: "‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä",
    fullName: "‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ",
    username: "‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§Æ",
    phoneNumber: "‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞",
    country: "‡§¶‡•á‡§∂",
    homeAddress: "‡§ò‡§∞ ‡§ï‡§æ ‡§™‡§§‡§æ",
    email: "‡§à‡§Æ‡•á‡§≤",
    memberSince: "‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§¨‡§®‡•á",
    emailCannotBeChanged: "‡§à‡§Æ‡•á‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§¨‡§¶‡§≤‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ",
    notProvided: "‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ",
    edit: "‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç",
    cancel: "‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
    saveChanges: "‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§® ‡§∏‡§π‡•á‡§ú‡•á‡§Ç",
    confirmLogout: "‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü ‡§ï‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç",
    areYouSureLogout: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?",
    loading: "‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...",
    loadingProfile: "‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...",
    login: "‡§≤‡•â‡§ó ‡§á‡§®",
    signUp: "‡§∏‡§æ‡§á‡§® ‡§Ö‡§™",
    password: "‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°",
    selectCountry: "‡§Ö‡§™‡§®‡§æ ‡§¶‡•á‡§∂ ‡§ö‡•Å‡§®‡•á‡§Ç",
    pleaseWait: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç...",
    createAccount: "‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§è‡§Ç",

    // Error messages
    error: "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø",
    fillAllFields: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç",
    loginError: "‡§≤‡•â‡§ó‡§ø‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø",
    signupError: "‡§∏‡§æ‡§á‡§®‡§Ö‡§™ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø",
    success: "‡§∏‡§´‡§≤‡§§‡§æ",
    accountCreated: "‡§ñ‡§æ‡§§‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ!",
    accountCreatedWithError: "‡§Ü‡§™‡§ï‡§æ ‡§ñ‡§æ‡§§‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§•‡§æ, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ü‡§™‡§ï‡•á ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§∏‡§π‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§•‡•Ä‡•§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: {0}\n\n‡§Ü‡§™ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§ê‡§™ ‡§Æ‡•á‡§Ç ‡§Ö‡§™‡§®‡•Ä ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§"
  }
};

// Health districts data
const healthDistricts: HealthDistrict[] = [
  {
    id: '1',
    name: 'Central Singapore',
    icon: 'üè¢',
    percentage: 85,
    color: '#4CAF50',
    description: 'Low health risk areas'
  },
  {
    id: '2',
    name: 'East Singapore',
    icon: 'üèòÔ∏è',
    percentage: 73,
    color: '#FF9800',
    description: 'Moderate dengue activity'
  },
  {
    id: '3',
    name: 'North Singapore',
    icon: 'üè¨',
    percentage: 92,
    color: '#2196F3',
    description: 'Good air quality'
  },
  {
    id: '4',
    name: 'West Singapore',
    icon: 'üè≠',
    percentage: 68,
    color: '#F44336',
    description: 'Higher PSI levels'
  },
  {
    id: '5',
    name: 'Northeast Singapore',
    icon: 'üè†',
    percentage: 79,
    color: '#9C27B0',
    description: 'Mixed health indicators'
  },
  {
    id: '6',
    name: 'Northwest Singapore',
    icon: 'üèòÔ∏è',
    percentage: 88,
    color: '#00BCD4',
    description: 'Improving health trends'
  }
];

interface HealthDistrict {
  id: string;
  name: string;
  icon: string;
  percentage: number;
  color: string;
  description: string;
}

interface UserData {
  username: string;
  email: string;
  country: string;
  homeAddress: string;
}

function CountryDropdown({
  value,
  onSelect,
  placeholder = "Select Country"
}: {
  value: string;
  onSelect: (country: string) => void;
  placeholder?: string;
}) {
  const [isOpen, setIsOpen] = useState(false);
  
  const countries = [
    "Singapore", "Malaysia", "Indonesia", "Thailand", "Philippines", "Vietnam",
    "Cambodia", "Laos", "Myanmar", "Brunei", "United States", "United Kingdom",
    "Australia", "Canada", "India", "China", "Japan", "South Korea", "Other"
  ];

  const handleSelect = (country: string) => {
    onSelect(country);
    setIsOpen(false);
  };

  return (
    <View>
      <TouchableOpacity
        style={{
          backgroundColor: 'rgba(255, 255, 255, 0.9)',
          borderRadius: 25,
          paddingHorizontal: 20,
          paddingVertical: 12,
          marginBottom: 15,
          justifyContent: 'center'
        }}
        onPress={() => setIsOpen(!isOpen)}
      >
        <Text style={{ color: value ? '#333' : '#999' }}>
          {value || placeholder}
        </Text>
      </TouchableOpacity>
      
      <Modal
        visible={isOpen}
        transparent={true}
        animationType="fade"
        onRequestClose={() => setIsOpen(false)}
      >
        <TouchableOpacity
          style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.5)', justifyContent: 'center' }}
          activeOpacity={1}
          onPress={() => setIsOpen(false)}
        >
          <View style={{
            backgroundColor: 'white',
            margin: 20,
            borderRadius: 10,
            maxHeight: 400,
          }}>
            <FlatList
              data={countries}
              keyExtractor={(item) => item}
              renderItem={({ item }) => (
                <TouchableOpacity
                  style={{
                    padding: 15,
                    borderBottomWidth: 1,
                    borderBottomColor: '#eee'
                  }}
                  onPress={() => handleSelect(item)}
                >
                  <Text style={{ fontSize: 16 }}>{item}</Text>
                </TouchableOpacity>
              )}
            />
          </View>
        </TouchableOpacity>
      </Modal>
    </View>
  );
}

function AuthScreen() {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [username, setUsername] = useState('');
  const [country, setCountry] = useState('');
  const [homeAddress, setHomeAddress] = useState('');
  const [loading, setLoading] = useState(false);

  const handleLogin = async () => {
    if (!email || !password) {
      Alert.alert('Error', 'Please fill in all fields');
      return;
    }

    setLoading(true);
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error: any) {
      Alert.alert('Login Error', error.message);
    }
    setLoading(false);
  };

  const handleSignup = async () => {
    if (!email || !password || !username || !country || !homeAddress) {
      Alert.alert('Error', 'Please fill in all fields');
      return;
    }

    setLoading(true);
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      // Save user data to Firestore
      try {
        await setDoc(doc(db, 'users', user.uid), {
          username,
          email,
          country,
          homeAddress,
          createdAt: new Date().toISOString(),
          quizPoints: 0,
          totalQuizAnswers: 0,
          correctAnswers: 0
        });
        Alert.alert('Success', 'Account created successfully!');
      } catch (firestoreError: any) {
        console.error('Firestore error:', firestoreError);
        Alert.alert(
          'Success',
          `Your account was created successfully, but there was an issue saving your profile data. Error: ${firestoreError.message}\n\nYou can update your profile later in the app.`
        );
      }
      
      resetForm();
    } catch (error: any) {
      Alert.alert('Signup Error', error.message);
    }
    setLoading(false);
  };

  const resetForm = () => {
    setEmail('');
    setPassword('');
    setUsername('');
    setCountry('');
    setHomeAddress('');
  };

  const toggleMode = () => {
    setIsLogin(!isLogin);
    resetForm();
  };

  return (
    <View style={styles.loginContainer}>
      <LinearGradient
        colors={['#0D1421', '#1A2332', '#2A3441']}
        style={styles.loginContent}
      >
        <KeyboardAvoidingView
          behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
          style={{ flex: 1, justifyContent: 'center', width: '100%' }}
        >
          <ScrollView contentContainerStyle={{ flexGrow: 1, justifyContent: 'center', alignItems: 'center', padding: 20 }}>
            <View style={{ marginBottom: 40 }}>
              <Text style={{ fontSize: 40, textAlign: 'center' }}>üèôÔ∏è</Text>
            </View>
            
            <Text style={{ fontSize: 36, fontWeight: 'bold', color: 'white', textAlign: 'center', marginBottom: 10 }}>Singapore Health Pulse</Text>
            <Text style={{ fontSize: 16, color: '#E8F5E8', textAlign: 'center', marginBottom: 40 }}>Real-time health monitoring for Singapore</Text>
            
            <View style={{ width: '100%', maxWidth: 300 }}>
              <TextInput
                style={{
                  backgroundColor: 'rgba(255, 255, 255, 0.9)',
                  borderRadius: 25,
                  paddingHorizontal: 20,
                  paddingVertical: 12,
                  marginBottom: 15,
                  fontSize: 16,
                  color: '#333'
                }}
                placeholder="Email"
                placeholderTextColor="#999"
                value={email}
                onChangeText={setEmail}
                keyboardType="email-address"
                autoCapitalize="none"
              />
              
              <TextInput
                style={{
                  backgroundColor: 'rgba(255, 255, 255, 0.9)',
                  borderRadius: 25,
                  paddingHorizontal: 20,
                  paddingVertical: 12,
                  marginBottom: 15,
                  fontSize: 16,
                  color: '#333'
                }}
                placeholder="Password"
                placeholderTextColor="#999"
                value={password}
                onChangeText={setPassword}
                secureTextEntry
              />
              
              {!isLogin && (
                <>
                  <TextInput
                    style={{
                      backgroundColor: 'rgba(255, 255, 255, 0.9)',
                      borderRadius: 25,
                      paddingHorizontal: 20,
                      paddingVertical: 12,
                      marginBottom: 15,
                      fontSize: 16,
                      color: '#333'
                    }}
                    placeholder="Username"
                    placeholderTextColor="#999"
                    value={username}
                    onChangeText={setUsername}
                  />
                  
                  <CountryDropdown
                    value={country}
                    onSelect={setCountry}
                    placeholder="Select your country"
                  />
                  
                  <TextInput
                    style={{
                      backgroundColor: 'rgba(255, 255, 255, 0.9)',
                      borderRadius: 25,
                      paddingHorizontal: 20,
                      paddingVertical: 12,
                      marginBottom: 15,
                      fontSize: 16,
                      color: '#333',
                      minHeight: 50
                    }}
                    placeholder="Home Address"
                    placeholderTextColor="#999"
                    value={homeAddress}
                    onChangeText={setHomeAddress}
                    multiline
                  />
                </>
              )}
             
             <TouchableOpacity
               style={[{
                 backgroundColor: '#4CAF50',
                 paddingVertical: 15,
                 paddingHorizontal: 30,
                 borderRadius: 25,
                 marginTop: 20,
                 width: '100%',
                 alignItems: 'center'
               }, loading && { opacity: 0.6 }]}
               onPress={isLogin ? handleLogin : handleSignup}
               disabled={loading}
             >
               <Text style={{
                 color: 'white',
                 fontSize: 16,
                 fontWeight: 'bold'
               }}>
                 {loading ? 'Please wait...' : (isLogin ? 'Login' : 'Create Account')}
               </Text>
             </TouchableOpacity>
             
             <TouchableOpacity
               style={{ marginTop: 20 }}
               onPress={toggleMode}
             >
               <Text style={{ color: '#4CAF50', fontSize: 16, textAlign: 'center' }}>
                 {isLogin ? "Don't have an account? Sign Up" : "Already have an account? Login"}
               </Text>
             </TouchableOpacity>
           </View>
         </ScrollView>
       </KeyboardAvoidingView>
     </LinearGradient>
   </View>
  );
}

function DistrictCard({ district }: { district: HealthDistrict }) {
  const buildingHeight = (district.percentage / 100) * 60;

  return (
    <View style={styles.districtCard}>
      <View style={styles.districtHeader}>
        <Text style={styles.districtIcon}>{district.icon}</Text>
        <Text style={styles.districtName}>{district.name}</Text>
      </View>
      
      <View style={styles.buildingContainer}>
        <View 
          style={[
            styles.building, 
            { 
              height: buildingHeight, 
              backgroundColor: district.color 
            }
          ]} 
        />
        <Text style={styles.percentage}>{district.percentage}%</Text>
      </View>
      
      <Text style={styles.description}>{district.description}</Text>
    </View>
  );
}

const getLivePopulationData = () => {
  // Real-time data from countrymeters.info
  const currentTime = new Date();
  const startOfYear = new Date(currentTime.getFullYear(), 0, 1);
  const dayOfYear = Math.floor((currentTime.getTime() - startOfYear.getTime()) / (1000 * 60 * 60 * 24));

  // Base data from the website
  const baseData = {
    currentPopulation: 6480987,
    birthsPerDay: 137,
    deathsPerDay: 67,
    migrationPerDay: 219,
    growthPerDay: 289
  };

  // Calculate year-to-date numbers
  const yearToDate = {
    births: Math.floor(baseData.birthsPerDay * dayOfYear),
    deaths: Math.floor(baseData.deathsPerDay * dayOfYear),
    migration: Math.floor(baseData.migrationPerDay * dayOfYear),
    growth: Math.floor(baseData.growthPerDay * dayOfYear)
  };

  // Simulate live counter with small variations
  const variation = (base: number, percentage: number = 0.001) => {
    const change = Math.floor(base * percentage * (Math.random() - 0.5));
    return base + change;
  };

  return {
    currentPopulation: variation(baseData.currentPopulation + yearToDate.growth),
    demographics: {
      male: { population: 3267057, percentage: 50.4 },
      female: { population: 3213930, percentage: 49.6 }
    },
    today: {
      births: variation(baseData.birthsPerDay, 0.1),
      deaths: variation(baseData.deathsPerDay, 0.1),
      migration: variation(baseData.migrationPerDay, 0.1),
      growth: variation(baseData.growthPerDay, 0.1)
    },
    yearToDate,
    additionalStats: {
      lifeExpectancy: 82.1,
      literacyRate: 96.81,
      populationDensity: 9168,
      worldRank: 114
    }
  };
};

// Fetch weekly dengue cases and labels
const fetchWeeklyDengueData = async (): Promise<{ labels: string[]; data: number[]; sum: number } | null> => {
  try {
    const response = await fetch('https://www.nea.gov.sg/dengue-zika/dengue/dengue-cases');
    const html = await response.text();
    const tableMatch = html.match(/Number of Reported Cases[\s\S]*?<table[\s\S]*?>([\s\S]*?)<\/table>/i);
    if (!tableMatch) return null;
    const tableHtml = tableMatch[1];
    // Extract date labels from header
    const labels = Array.from(tableHtml.matchAll(/<th[^>]*>([^<]+)<\/th>/g)).map(m => m[1].trim()).slice(0, 7);
    // Extract daily counts
    const data = Array.from(tableHtml.matchAll(/<td[^>]*>(\d+)<\/td>/g)).map(m => parseInt(m[1], 10)).slice(0, 7);
    // Calculate sum of weekly cases
    const sum = data.reduce((acc, n) => acc + n, 0);
    return { labels, data, sum };
  } catch (error) {
    console.error('Error fetching weekly dengue data:', error);
    return null;
  }
};

function BottomNavigation({
  activeTab,
  onTabPress
}: {
  activeTab: string;
  onTabPress: (tab: string) => void;
}) {
  const { translations, language } = useContext(LanguageContext);
  const t = translations[language];

  const tabs = [
    { id: 'home', label: t.home, icon: 'home' },
    { id: 'map', label: t.map, icon: 'map-marked-alt' },
    { id: 'quiz', label: t.quiz, icon: 'question-circle' },
    { id: 'report', label: t.reports, icon: 'clipboard-list' },
    { id: 'info', label: t.profile, icon: 'user' },
  ];

  return (
    <View style={styles.bottomNavigation}>
      {tabs.map((tab) => (
        <TouchableOpacity
          key={tab.id}
          style={[
            styles.navItem,
            activeTab === tab.id && styles.activeNavItem,
          ]}
          onPress={() => onTabPress(tab.id)}
        >
          <FontAwesome5
            name={tab.icon}
            size={20}
            style={{
              marginBottom: 2,
              color: activeTab === tab.id ? '#4CAF50' : '#B0BEC5',
            }}
            solid
          />
          <Text style={{
            fontSize: 10,
            color: activeTab === tab.id ? '#4CAF50' : '#B0BEC5',
            fontWeight: activeTab === tab.id ? '600' : '400',
          }}>
            {tab.label}
          </Text>
        </TouchableOpacity>
      ))}
    </View>
  );
}

function Dashboard({ user }: { user: User }) {
  const [activeTab, setActiveTab] = useState('home');

  const renderActiveScreen = () => {
    switch (activeTab) {
      case 'home':
        return <SafeAreaView style={{ flex: 1 }}><HomeScreen user={user} /></SafeAreaView>;
      case 'map':
        return <SafeAreaView style={{ flex: 1 }}><SingaporeMapScreen user={user} /></SafeAreaView>;
      case 'quiz':
        return <SafeAreaView style={{ flex: 1 }}><QuizScreen user={user} /></SafeAreaView>;
      case 'report':
        return <SafeAreaView style={{ flex: 1 }}><MapScreen user={user} /></SafeAreaView>;
      case 'info':
        return <SafeAreaView style={{ flex: 1 }}><InfoScreen user={user} /></SafeAreaView>;
      default:
        return <SafeAreaView style={{ flex: 1 }}><HomeScreen user={user} /></SafeAreaView>;
    }
  };

  return (
    <View style={[styles.dashboardContainer, { backgroundColor: '#0D1421', flex: 1 }]}>
      <StatusBar style="light" backgroundColor="transparent" translucent={true} />
      <LinearGradient
        colors={['#0D1421', '#121E3A']}
        style={{ flex: 1 }}
      >
        {renderActiveScreen()}

        {/* Health AI Chatbot Button - Only show on home screen */}
        {activeTab === 'home' && (
          <ChatbotButton
            openaiApiKey={process.env.EXPO_PUBLIC_OPENAI_API_KEY}
            userLocation="Singapore"
          />
        )}
      </LinearGradient>
      <SafeAreaView style={{ backgroundColor: 'rgba(13, 20, 33, 0.95)' }}>
        <BottomNavigation
          activeTab={activeTab}
          onTabPress={(tab: string) => setActiveTab(tab)}
        />
      </SafeAreaView>
    </View>
  );
}

export default function App() {
  const [user, setUser] = useState<User | null>(null);
  const [initializing, setInitializing] = useState(true);
  const [language, setLanguage] = useState('english');

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user: User | null) => {
      setUser(user);
      setInitializing(false);
    });

    return unsubscribe;
  }, []);

  if (initializing) {
    return (
      <View style={{ flex: 1, backgroundColor: '#0D1421', justifyContent: 'center', alignItems: 'center' }}>
        <StatusBar style="light" backgroundColor="transparent" translucent={true} />
        <Text style={{ color: 'white', fontSize: 18 }}>Loading...</Text>
      </View>
    );
  }

  return (
    <LanguageContext.Provider value={{ language, setLanguage, translations }}>
      <View style={{ flex: 1, backgroundColor: '#0D1421' }}>
        <StatusBar style="light" backgroundColor="transparent" translucent={true} />
        {user ? <Dashboard user={user} /> : <AuthScreen />}
      </View>
    </LanguageContext.Provider>
  );
} 